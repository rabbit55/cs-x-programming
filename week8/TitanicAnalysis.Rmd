---
title: "TitanicAnalysis"
author: "AmyHs , slimykat , Rabbit55"
date: "2018å¹?5???2?—¥"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#å¥—ä»¶???
```{r}
library(ggplot2)
library(e1071)
library(knitr)
```

#è³‡æ??
```{r}
train<-read.csv("titanicTrain.csv")
train<-train[-c(1001:1310),]
quest<-read.csv("titanicQuestion.csv")
train<-rbind(train,train)
```

#è³‡æ?™ç¼ºå¤±é??
```{r}
is_na<-function(x){
  sum(is.na(x))
}
sapply(train,is_na)
sapply(quest,is_na)
```

#è³‡æ?™æŽ¢ç´?
##0.1è³‡æ?™è?‰æ??
```{r}
train$survived<-as.factor(train$survived)
train$pclass<-as.ordered(train$pclass)
```

##0.2?§åˆ¥??‡æ­»äº?
```{r}
ggplot(train[!is.na(train$survived),], aes(x = sex, fill = survived)) +
  geom_bar(stat='count', position='dodge') + theme_grey() +
  labs(x = 'Training data only') +
  geom_label(stat='count', aes(label=..count..))
```

##0.3æ­»äº¡??‡pclass
###0.3.1 class??‡æ­»äº?
```{r}
ggplot(train[!is.na(train$survived),], aes(x = pclass, fill = survived)) +
  geom_bar(stat='count', position='dodge') + labs(x = 'Training data only') +
  theme(legend.position="none") 
```

###0.3.2 class& sex &æ­»äº¡
```{r}
ggplot(train[!is.na(train$survived),], aes(x = pclass, fill = survived)) +
  geom_bar(stat='count', position='fill') +
  labs(x = 'Training data only', y= "Percent") + facet_grid(.~sex) 
```

##0.4 fare&æ­»äº¡
```{r}
train[train$fare==0,]
#?™¼?¾??‰class1ä¸­fare=0??„äººå¾ˆå?šï?Œå¥½??ç¥¨?ƒ¹è·Ÿé?Žç?šæ?–å¹´é½¡ç?„ç›´?Ž¥??œè¯??‹ä?å‡ºä¾?
ggplot(train[!is.na(train$survived),], aes(x = fare, fill = survived)) +
  geom_histogram( bins= 30) +
  labs(x = 'Training data only', y= "Count") + facet_grid(.~pclass)
#??‹ä?å‡ºä»éº¼ç?æ??
```

##0.5 ç¼ºå¤±?¼è?•ç??
###0.5.1??ˆè§£æ±ºboat??„ç¼ºå¤±å?
```{r}
train$boat = as.numeric(train$boat != "")
```

###0.5.2?”¨?¾??‰è?‡æ?™é?æ¸¬å¹´ç???„ç¼ºå¤±å?
```{r}
agelm <- lm(age ~ pclass+boat+sex+parch+sibsp, data=train[!is.na(train$age),])
#??‹ä?ä¸‹å“ªä¸?…é?æ¸¬??›è?ƒå¥½ï¼Œä»¥??ŠR^2?
summary(agelm)
train$agelm<-predict(agelm,train)
```

###0.5.3??æ¸¬çµæ?œæ?”è??
```{r}
hist(train$age[!is.na(train$age)], main='Original data, non-missing', xlab='age')
hist(train$agelm, main= 'LM predictions', xlab='age', xlim=range(0:80))
```

###0.5.4å°‡ç¼º¼è?œé??
```{r}
indexMissingAge <- which(is.na(train$age))
train$age[indexMissingAge] <- train$agelm[indexMissingAge]

fare_NAindex = which(is.na(train$fare))
#?™¼?¾??æ??3701??Ÿç¥¨? ¹??„å®¢äººåœ¨fare factor??•æ?‰na
temp = train$fare[nchar( as.character(train$ticket)) == 4 & grepl("^3",as.character(train$ticket))]
average = sum(temp[!is.na(temp)])/(length(temp)-1)
train[fare_NAindex,"fare"] = average
#å°‡é?žä¼¼ç¥¨æ ¹??Ÿç?„ç¥¨?ƒ¹??–å¹³???

#å°‡è?‡æ?™æ?†å?†æ?å?›å‹å?å¡?
female_insea = train[train$sex == "female" & train$boat == 0,c("age","fare","survived")]
female_onboat = train[train$sex == "female" & train$boat == 1,c("age","fare","survived")]
male_insea = train[train$sex == "male" & train$boat == 0,c("age","fare","survived")]
male_onboat = train[train$sex == "male" & train$boat == 1,c("age","fare","survived")]

female_insea[,3] = as.factor(female_insea[,3])
female_onboat[,3] = as.factor(female_onboat[,3])
male_insea[,3] = as.factor(male_insea[,3])
male_onboat[,3] = as.factor(male_onboat[,3])

#å°fare??–log10æ¸›å?‘æ•¸??šå?ç§»
female_insea[,2] = log10(female_insea[,2])
female_onboat[,2] = as.factor(female_onboat[,2])
male_insea[,2] = as.factor(male_insea[,2])
male_onboat[,2] = as.factor(male_onboat[,2])
```

##0.5 SVM
```{r}
#??†åˆ¥å°æ?å‹å?å¡Šå?šSVM

plot_svm <- function(dat){
  survived = as.numeric(dat[,3])
  train_index = !is.na(survived)
  svmfit = svm(survived[train_index] ~ ., data = dat[train_index,],gamma = 1, cost = 100)
  return(svmfit)
}
par(mfrow=c(2,2))

svm1 = plot_svm(female_insea)
#plot(temp,female_insea[!is.na(female_insea$survived),])
svm2 = plot_svm(female_onboat)
# plot(temp,female_onboat[!is.na(female_onboat$survived),])
svm3 = plot_svm(male_insea)
# plot(temp,male_insea[!is.na(male_insea$survived),])
svm4 = plot_svm(male_onboat)
# plot(temp,male_onboat[!is.na(male_onboat$survived),])

outcome1 = data.frame(predict(svm1,female_insea[is.na(female_insea$survived),c(1:2)]))
outcome2 = data.frame(predict(svm2,female_onboat[is.na(female_onboat$survived),c(1:2)]))
outcome3 = data.frame(predict(svm3,male_insea[is.na(male_insea$survived),c(1:2)]))
outcome4 = data.frame(predict(svm4,male_onboat[is.na(male_onboat$survived),c(1:2)]))

#??ˆä½µçµæ?œé²è?Œè¼¸?‡º
names(outcome1) = "y"
names(outcome2) = "y"
names(outcome3) = "y"
names(outcome4) = "y"

ans = rbind(outcome1,outcome2,outcome3,outcome4)
index = order(row.names(ans))
ans = ans[index,]
write.csv(ans,file="titanicPrediction.csv")

kable(ans)
```

